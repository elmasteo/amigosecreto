<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Amigo Secreto — Registro</title>
<style>
  :root {
    --primary: #6c63ff;
    --primary-hover: #574fd6;
    --bg: #f9fafb;
    --card-bg: #fff;
    --border: #e5e7eb;
    --text: #111827;
    --text-muted: #6b7280;
    --radius: 12px;
    --shadow: 0 8px 20px rgba(0,0,0,.06);
  }
  body {
    font-family: system-ui, Segoe UI, Roboto, Arial;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    padding: 32px;
  }
  .card {
    max-width: 900px;
    margin: 0 auto;
    padding: 24px;
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: var(--shadow);
  }
  h1 {
    margin-bottom: 16px;
    font-size: 1.8rem;
    color: var(--primary);
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }
  input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-top: 4px;
    box-sizing: border-box;
  }
  button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1rem;
    margin-top: 8px;
    transition: background 0.2s;
  }
  button:hover {
    background: var(--primary-hover);
  }
  #add-gift {
    background: #e5e7eb;
    color: var(--text);
  }
  #add-gift:hover {
    background: #d1d5db;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: var(--card-bg);
    border-radius: var(--radius);
    overflow: hidden;
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  th {
    background: #f3f4f6;
    font-weight: 600;
    color: var(--text-muted);
  }
  tr:hover td {
    background: #f9fafb;
  }
  .small {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 8px;
  }
</style>
</head>
<body>
  <div class="card">
    <h1>Registro Amigo Secreto</h1>
    <form id="entry-form">
      <label>Nombre
        <input id="name" required />
      </label>

      <div id="gifts-container">
        <label>Regalo 1
          <input class="gift" required />
        </label>
      </div>
      <button id="add-gift" type="button">+ Agregar opción</button>
      <button type="submit">Enviar</button>
    </form>

    <p class="small">
      Las entradas registradas aparecerán abajo. La asignación final se realizará una vez estén todos los participantes.
    </p>

    <table id="entries-table">
      <thead>
        <tr>
          <th># Generado</th>
          <th>ID</th>
          <th>Opciones de regalo</th>
          <th># Asignado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const addGiftBtn = document.getElementById('add-gift');
const giftsContainer = document.getElementById('gifts-container');
let giftCount = 1;

addGiftBtn.addEventListener('click', () => {
  giftCount++;
  const label = document.createElement('label');
  label.innerHTML = `Regalo ${giftCount} <input class="gift" />`;
  giftsContainer.appendChild(label);
});

const form = document.getElementById('entry-form');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const gifts = Array.from(document.querySelectorAll('.gift'))
                    .map(i => i.value.trim())
                    .filter(Boolean);
  if(!name || gifts.length===0){ alert('Nombre y al menos 1 regalo.'); return; }

  const body = { name, gifts };
  const res = await fetch('/.netlify/functions/save-entry', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  if(res.ok){
    document.getElementById('name').value='';
    document.querySelectorAll('.gift').forEach((el,i)=> {
      if(i>0) el.parentElement.remove();
      else el.value='';
    });
    giftCount = 1;
    loadPublicEntries();
  } else {
    const txt = await res.text();
    alert('Error: '+txt);
  }
});

async function loadPublicEntries(){
  const res = await fetch('/.netlify/functions/get-public-entries');
  if(!res.ok) return;
  const entries = await res.json();
  const tbody = document.querySelector('#entries-table tbody');
  tbody.innerHTML = '';
  entries.forEach(e=>{
    const tr = document.createElement('tr');
    const gifts = (e.gifts || []).join(', ');
    tr.innerHTML = `<td>${e.generatedNumber}</td><td>${e.id}</td><td>${gifts}</td><td>${e.assignedRecipient}</td>`;
    tbody.appendChild(tr);
  });
}

loadPublicEntries();
</script>
</body>
</html>
